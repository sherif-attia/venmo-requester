name: Release
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install dependencies
        run: npm install -g semantic-release @semantic-release/git @semantic-release/github @semantic-release/changelog @semantic-release/commit-analyzer @semantic-release/release-notes-generator

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SEMANTIC_RELEASE_CONFIG: |
            {
              "branches": ["main"],
              "plugins": [
                "@semantic-release/commit-analyzer",
                "@semantic-release/release-notes-generator",
                ["@semantic-release/changelog", {
                  "changelogFile": "CHANGELOG.md"
                }],
                ["@semantic-release/github", {
                  "assets": [],
                  "successComment": "ðŸŽ‰ This change is included in version ${nextRelease.version}",
                  "failTitle": "The release failed",
                  "failComment": "The release failed. Please check the workflow run for details.",
                  "labels": ["released"]
                }],
                ["@semantic-release/git", {
                  "assets": ["CHANGELOG.md", "pyproject.toml"],
                  "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                }]
              ]
            }
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          echo "$SEMANTIC_RELEASE_CONFIG" > .releaserc.json
          semantic-release
